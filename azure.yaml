# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: fake-saas-demo
metadata:
  template: fake-saas-demo@0.0.1-beta
  description: A Python FastAPI SaaS demo application deployed to Azure Container Apps

workflow:
  # Automatically provision and deploy on azd up
  up:
    - azd provision
    - azd deploy

services:
  api:
    project: ./src
    language: python
    host: containerapp

hooks:
  preprovision:
    shell: pwsh
    run: |
      Write-Host "Setting up environment variables..."
      # Ensure DEMO_API_KEY is set
      $apiKey = azd env get-value DEMO_API_KEY
      if ([string]::IsNullOrEmpty($apiKey)) {
        Write-Host "Setting default DEMO_API_KEY..."
        azd env set DEMO_API_KEY "demo-key-12345"
      }
  predeploy:
    shell: pwsh
    run: |
      Write-Host "Building container image using Azure Container Registry..." -ForegroundColor Green
      
      # Get infrastructure outputs
      $outputs = azd env get-values --output json | ConvertFrom-Json
      $acrName = $outputs.AZURE_CONTAINER_REGISTRY_NAME
      $imageName = "fake-saas-api:$($env:AZURE_ENV_NAME)"
      
      Write-Host "Building image: $imageName in ACR: $acrName" -ForegroundColor Cyan
      
      # Build image directly in ACR (no local Docker needed!)
      az acr build --registry $acrName --image $imageName --file Dockerfile .